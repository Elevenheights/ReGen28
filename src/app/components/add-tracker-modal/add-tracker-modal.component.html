<!-- Premium Add Tracker Modal -->
<ion-modal [isOpen]="isOpen" (didDismiss)="close()" class="premium-modal">
	<ng-template>
		<div class="h-full bg-neutral-50 flex flex-col relative">

			<!-- 1. Header (Premium Glassmorphism) -->
			<ion-header class="ion-no-border">
				<div
					class="px-6 pt-10 pb-6 bg-white/90 backdrop-blur-2xl sticky top-0 z-50 border-b border-neutral-100/30 overflow-hidden">
					<!-- Ambient Glow -->
					<div class="absolute -top-10 -left-10 w-40 h-40 bg-indigo-500/5 rounded-full blur-3xl"></div>

					<div class="flex items-center justify-between mb-6 relative z-10">
						<div class="flex items-center gap-4">
							<div
								class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600 shadow-sm">
								<i class="fa-solid fa-plus-circle text-xl"></i>
							</div>
							<div>
								<h2 class="text-2xl font-black text-neutral-900 tracking-tighter">{{ stepTitle }}</h2>
								<p class="text-[9px] text-neutral-400 font-black uppercase tracking-[0.2em]">Sequence {{
									stepIndex + 1 }} of 4</p>
							</div>
						</div>
						<button (click)="close()"
							class="w-12 h-12 rounded-2xl bg-neutral-100/50 flex items-center justify-center text-neutral-400 active:scale-90 transition-all hover:bg-neutral-100 hover:text-neutral-900 shadow-sm">
							<i class="fa-solid fa-times text-xl"></i>
						</button>
					</div>

					<!-- Progress Indicator -->
					<div class="flex items-center gap-2 px-1 relative z-10" role="progressbar"
						[attr.aria-valuenow]="stepIndex + 1" aria-valuemin="1" aria-valuemax="4"
						[attr.aria-label]="'Step ' + (stepIndex + 1) + ' of 4: ' + stepTitle">
						<div *ngFor="let i of [0, 1, 2, 3]"
							class="h-1.5 rounded-full transition-all duration-700 ease-out shadow-sm"
							[class.flex-1]="stepIndex === i" [class.w-4]="stepIndex !== i"
							[class.bg-indigo-500]="stepIndex >= i" [class.bg-neutral-100]="stepIndex < i"
							[class.shadow-indigo-200]="stepIndex >= i" aria-hidden="true">
						</div>
					</div>
				</div>
			</ion-header>

			<!-- 2. Content -->
			<ion-content [fullscreen]="true" class="ion-padding-bottom" [style.--background]="'transparent'">
				<div class="px-5 pt-6 pb-32 space-y-6">

					<!-- Step 1: Category Selection -->
					<div *ngIf="currentStep === 'category'" class="space-y-6 animate-entry">
						<div class="text-center space-y-1">
							<h3 class="text-lg font-bold text-neutral-900">Define your focus</h3>
							<p class="text-sm text-neutral-500">What aspect of your wellness are you nurturing?</p>
						</div>

						<div class="grid grid-cols-2 gap-3">
							<button *ngFor="let category of categories" (click)="selectCategory(category.value)"
								class="card-elevated p-6 text-left relative overflow-hidden group border-2 shadow-2xl transition-all duration-500"
								[style.border-color]="selectedCategory === category.value ? category.color : 'transparent'"
								[style.background]="selectedCategory === category.value ? category.color + '05' : 'white'">

								<!-- Icon Wrapper -->
								<div class="w-14 h-14 rounded-2xl flex items-center justify-center mb-5 transition-transform duration-500 group-hover:scale-110 group-active:scale-95 shadow-lg"
									[style.background]="'linear-gradient(135deg, ' + category.color + ', ' + category.color + 'cc)'">
									<i [class]="'fa-solid ' + category.icon + ' text-white text-2xl'"></i>
								</div>

								<h3 class="font-black text-neutral-900 text-lg mb-1.5 tracking-tight">{{ category.label
									}}</h3>
								<p
									class="text-[10px] text-neutral-400 leading-relaxed font-bold uppercase tracking-widest">
									{{
									category.description }}</p>

								<!-- Selection Indicator (Premium) -->
								<div *ngIf="selectedCategory === category.value"
									class="absolute top-5 right-5 w-6 h-6 rounded-full flex items-center justify-center text-white shadow-lg animate-scale-in"
									[style.background-color]="category.color">
									<i class="fa-solid fa-check text-xs"></i>
								</div>
							</button>
						</div>
					</div>

					<!-- Step 2: Template Selection -->
					<div *ngIf="currentStep === 'template'" class="space-y-6 animate-entry">
						<div class="text-center space-y-1">
							<h3 class="text-lg font-bold text-neutral-900">Choose a path</h3>
							<p class="text-sm text-neutral-500">Pick a proven template or design your own.</p>
						</div>

						<button (click)="skipTemplate()"
							class="w-full card-glass p-8 border-2 border-dashed border-neutral-200 text-center hover:border-indigo-400 hover:bg-white hover:shadow-2xl hover:shadow-indigo-500/10 transition-all group relative overflow-hidden active:scale-[0.98]">
							<!-- Decorative elements -->
							<div
								class="absolute -top-10 -right-10 w-24 h-24 bg-indigo-500/5 rounded-full blur-2xl group-hover:bg-indigo-500/10">
							</div>

							<div
								class="w-16 h-16 rounded-2xl bg-neutral-50 flex items-center justify-center mx-auto mb-4 group-hover:scale-110 group-active:scale-95 transition-all shadow-sm group-hover:shadow-indigo-100 group-hover:bg-indigo-50 group-hover:text-indigo-500">
								<i class="fa-solid fa-magic-wand-sparkles text-2xl"></i>
							</div>
							<p class="font-black text-neutral-950 text-xl tracking-tight">Vanguard Path</p>
							<p class="text-[9px] text-neutral-400 font-bold uppercase tracking-[0.2em] mt-2">Design a
								unique ritual</p>
						</button>

						<div *ngIf="availableTemplates.length > 0" class="space-y-4">
							<div class="flex items-center gap-4 px-1">
								<span class="text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em]">Sacred
									Blueprints</span>
								<div class="h-px bg-neutral-100 flex-1"></div>
							</div>

							<button *ngFor="let template of availableTemplates"
								(click)="selectTemplate(template); goNext()"
								class="w-full card-elevated p-5 flex items-center space-x-5 group relative overflow-hidden transition-all duration-500 hover:shadow-2xl active:scale-[0.98]"
								[class.ring-2]="selectedTemplate?.name === template.name"
								[class.ring-indigo-500]="selectedTemplate?.name === template.name">

								<div class="w-16 h-16 rounded-[1.5rem] flex items-center justify-center flex-shrink-0 transition-transform group-hover:scale-110 group-active:scale-90 shadow-lg"
									[style.background]="'linear-gradient(135deg, ' + template.color + ', ' + template.color + 'cc)'">
									<i [class]="'fa-solid ' + template.icon + ' text-white text-2xl'"></i>
								</div>

								<div class="flex-1 text-left">
									<h4 class="font-black text-neutral-900 text-lg tracking-tight">{{ template.name }}
									</h4>
									<p class="text-[10px] text-indigo-500 font-bold uppercase tracking-widest mt-1">
										{{ template.target }} {{ template.unit }} â€¢ {{ template.frequency }}
									</p>
								</div>

								<div
									class="w-10 h-10 rounded-xl bg-neutral-50 flex items-center justify-center text-neutral-300 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition-all">
									<i class="fa-solid fa-chevron-right text-sm"></i>
								</div>
							</button>
						</div>

						<div *ngIf="availableTemplates.length === 0"
							class="text-center py-12 glass-panel rounded-[2rem]">
							<div
								class="w-16 h-16 rounded-full bg-neutral-100 flex items-center justify-center mx-auto mb-4 text-neutral-300">
								<i class="fa-solid fa-box-open text-3xl"></i>
							</div>
							<p class="text-sm font-bold text-neutral-400 uppercase tracking-widest">No templates found
							</p>
							<p class="text-xs text-neutral-400 mt-1">Go custom to build exactly what you need</p>
						</div>
					</div>

					<!-- Step 3: Customize -->
					<div *ngIf="currentStep === 'customize'" class="space-y-8 animate-entry">

						<!-- Name Section -->
						<div
							class="card-glass rounded-[2.5rem] p-6 border border-white/50 shadow-2xl shadow-indigo-500/5 space-y-4 focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
							<div class="flex items-center gap-4">
								<div class="w-16 h-16 rounded-[1.25rem] flex items-center justify-center transition-all shadow-xl group cursor-pointer"
									[style.background-color]="trackerForm.color" (click)="toggleIconPicker()">
									<i
										[class]="'fa-solid ' + trackerForm.icon + ' text-white text-3xl group-hover:scale-110 transition-transform'"></i>
								</div>
								<div class="flex-1">
									<label
										class="block text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-1.5">Sacred
										Name</label>
									<input type="text" [(ngModel)]="trackerForm.name" placeholder="Name your ritual..."
										class="w-full bg-transparent text-2xl font-black text-neutral-900 placeholder-neutral-200 focus:outline-none border-none p-0 tracking-tight">
								</div>
							</div>
						</div>

						<!-- Quick Adjust Section -->
						<div class="space-y-4">
							<div class="flex items-center gap-4">
								<div class="h-px bg-neutral-200 flex-1"></div>
								<span
									class="text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em]">Mechanics</span>
								<div class="h-px bg-neutral-200 flex-1"></div>
							</div>

							<!-- Grid of Settings -->
							<div class="grid grid-cols-2 gap-3">
								<!-- Type Selector -->
								<div
									class="card-glass rounded-[2rem] p-5 border border-white/50 shadow-sm relative overflow-hidden group hover:bg-white/95 transition-all">
									<label
										class="block text-[9px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-3">Logic</label>
									<div class="flex flex-col gap-2">
										<div class="flex items-center gap-2">
											<i class="fa-solid fa-sliders text-indigo-500"></i>
											<span class="text-sm font-black text-neutral-900">{{ trackerForm.type |
												titlecase }}</span>
										</div>
										<ion-select [(ngModel)]="trackerForm.type" interface="popover"
											class="absolute inset-0 opacity-0 cursor-pointer">
											<ion-select-option *ngFor="let type of typeOptions" [value]="type.value">{{
												type.label }}</ion-select-option>
										</ion-select>
									</div>
								</div>

								<!-- Frequency Selector -->
								<div
									class="card-glass rounded-[2rem] p-5 border border-white/50 shadow-sm relative overflow-hidden group hover:bg-white/95 transition-all">
									<label
										class="block text-[9px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-3">Cycle</label>
									<div class="flex flex-col gap-2">
										<div class="flex items-center gap-2">
											<i class="fa-solid fa-rotate text-emerald-500"></i>
											<span class="text-sm font-black text-neutral-900">{{
												trackerForm.frequency |
												titlecase }}</span>
										</div>
										<ion-select [(ngModel)]="trackerForm.frequency" interface="popover"
											class="absolute inset-0 opacity-0 cursor-pointer">
											<ion-select-option *ngFor="let freq of frequencyOptions"
												[value]="freq.value">{{ freq.label }}</ion-select-option>
										</ion-select>
									</div>
								</div>

								<!-- Target Selector -->
								<div class="card-glass rounded-[2rem] p-5 border border-white/50 shadow-sm col-span-1">
									<label
										class="block text-[9px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-3">Daily
										Quota</label>
									<div class="flex items-center gap-3">
										<input type="number" [(ngModel)]="trackerForm.target"
											class="w-12 text-xl font-black text-neutral-900 bg-transparent border-none p-0 focus:outline-none">
										<span
											class="text-[9px] text-neutral-400 font-black uppercase tracking-widest">{{
											trackerForm.unit }}</span>
									</div>
								</div>

								<!-- Color Picker -->
								<div
									class="card-glass rounded-[2rem] p-5 border border-white/50 shadow-sm col-span-1 relative flex items-center justify-between">
									<label
										class="block text-[9px] font-black text-neutral-400 uppercase tracking-[0.2em]">Aura</label>
									<div class="w-10 h-10 rounded-full shadow-inner border-2 border-white ring-2 ring-neutral-50 overflow-hidden cursor-pointer active:scale-90 transition-all"
										[style.background-color]="trackerForm.color">
										<input type="color" [(ngModel)]="trackerForm.color"
											class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Icon Picker (Inline/Expanded) -->
					<div *ngIf="showIconPicker" class="animate-entry-up">
						<div class="bg-white rounded-[2rem] p-5 border-2 border-indigo-100 shadow-lg space-y-4">
							<div class="flex justify-between items-center">
								<span class="text-xs font-black text-neutral-900 uppercase tracking-wider">Select
									Icon</span>
								<button (click)="toggleIconPicker()" class="text-neutral-400"><i
										class="fa-solid fa-times"></i></button>
							</div>
							<div class="grid grid-cols-5 gap-3">
								<button *ngFor="let icon of iconOptions" (click)="selectIcon(icon)"
									class="w-12 h-12 rounded-xl flex items-center justify-center transition-all border border-neutral-50"
									[class.bg-indigo-500]="trackerForm.icon === icon"
									[class.text-white]="trackerForm.icon === icon"
									[class.bg-neutral-50]="trackerForm.icon !== icon"
									[class.text-neutral-400]="trackerForm.icon !== icon">
									<i [class]="'fa-solid ' + icon"></i>
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- Step 4: Duration -->
				<div *ngIf="currentStep === 'duration'" class="space-y-8 animate-entry">
					<div class="text-center space-y-1">
						<h3 class="text-lg font-bold text-neutral-900">Make it a habit</h3>
						<p class="text-sm text-neutral-500">Pick a duration that challenges you.</p>
					</div>

					<!-- Duration Presets -->
					<div class="grid grid-cols-2 gap-3">
						<button *ngFor="let preset of durationPresets" (click)="selectDuration(preset.days)"
							class="card-elevated p-6 text-left relative overflow-hidden group transition-all duration-500 border-2"
							[class.border-amber-500]="isDurationSelected(preset.days)"
							[class.bg-amber-500]="isDurationSelected(preset.days)"
							[class.text-white]="isDurationSelected(preset.days)"
							[class.scale-[1.02]]="isDurationSelected(preset.days)"
							[class.border-transparent]="!isDurationSelected(preset.days)"
							[class.bg-white]="!isDurationSelected(preset.days)">

							<div class="flex justify-between items-center mb-2">
								<span class="text-2xl font-black tracking-tighter">{{ preset.label }}</span>
								<i *ngIf="preset.days === -1" class="fa-solid fa-infinity opacity-50"></i>
							</div>
							<p class="text-[9px] font-black uppercase tracking-widest opacity-80">{{
								preset.description }}</p>

							<!-- Hover Glow -->
							<div
								class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity">
							</div>
						</button>
					</div>

					<!-- Final Preview Card -->
					<div class="space-y-4">
						<div class="flex items-center gap-4">
							<div class="h-px bg-neutral-200 flex-1"></div>
							<span class="text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em]">Final
								Preview</span>
							<div class="h-px bg-neutral-200 flex-1"></div>
						</div>

						<div
							class="card-elevated p-6 flex items-center gap-6 shadow-2xl shadow-indigo-500/10 border border-white/50 relative overflow-hidden group">
							<!-- Ambient glow -->
							<div
								class="absolute inset-0 bg-gradient-to-br from-transparent via-transparent to-white/10 pointer-events-none">
							</div>

							<div class="w-20 h-20 rounded-3xl flex items-center justify-center shadow-2xl transition-transform duration-500 group-hover:rotate-6 group-active:scale-90"
								[style.background]="'linear-gradient(135deg, ' + trackerForm.color + ', ' + trackerForm.color + 'dd)'">
								<i [class]="'fa-solid ' + trackerForm.icon + ' text-white text-3xl'"></i>
							</div>
							<div class="flex-1">
								<h3 class="text-xl font-black text-neutral-950 tracking-tighter">{{ trackerForm.name
									|| 'New Habits' }}</h3>
								<div class="flex flex-wrap items-center gap-x-4 gap-y-1.5 mt-2">
									<div
										class="flex items-center gap-1.5 text-[10px] font-black tracking-widest uppercase text-indigo-500 bg-indigo-50/50 px-2 py-1 rounded-lg">
										<i class="fa-solid fa-bullseye"></i>
										<span>{{ trackerForm.target }} {{ trackerForm.unit }} / {{
											trackerForm.frequency }}</span>
									</div>
									<div
										class="flex items-center gap-1.5 text-[10px] font-black tracking-widest uppercase text-amber-500 bg-amber-50/50 px-2 py-1 rounded-lg">
										<i class="fa-solid fa-calendar"></i>
										<span>{{ trackerForm.isOngoing ? 'Eternal' : trackerForm.durationDays + '
											Cycles' }}</span>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Reminder Toggle (Premium) -->
					<div
						class="card-glass rounded-[2rem] p-6 border border-white/50 shadow-sm flex items-center justify-between group active:bg-white transition-all">
						<div class="flex items-center gap-4">
							<div
								class="w-14 h-14 rounded-2xl bg-amber-50 flex items-center justify-center text-amber-500 transition-all duration-500 group-hover:bg-amber-100/50 group-hover:scale-110 shadow-inner">
								<i class="fa-solid fa-bell-ring animate-bounce-slow text-xl"></i>
							</div>
							<div>
								<h4 class="font-black text-neutral-900 text-sm tracking-tight">Divine Reminders</h4>
								<p class="text-[9px] text-neutral-400 font-bold uppercase tracking-widest mt-1">A gentle
									nudge for your spirit</p>
							</div>
						</div>
						<ion-toggle [(ngModel)]="trackerForm.reminderEnabled" color="warning"
							class="scale-110"></ion-toggle>
					</div>

					<!-- Reminder Time (Conditional) -->
					<div *ngIf="trackerForm.reminderEnabled" class="animate-entry-up px-2">
						<div
							class="flex items-center justify-between p-5 bg-orange-50/50 rounded-[1.5rem] border border-orange-100 shadow-inner">
							<span class="text-[9px] font-black text-orange-600 uppercase tracking-[0.2em]">Sacred
								timing</span>
							<input type="time" [(ngModel)]="trackerForm.reminderTime"
								class="bg-white rounded-xl px-4 py-2 text-sm font-black text-neutral-900 shadow-sm border-none focus:ring-2 focus:ring-orange-100 outline-none">
						</div>
					</div>
				</div>

		</div>
		</ion-content>

		<!-- 3. Action Footer -->
		<ion-footer class="ion-no-border bg-transparent shadow-none">
			<div class="px-6 pb-6 pt-2">
				<div class="flex gap-3">
					<!-- Back Button -->
					<button *ngIf="canGoBack" (click)="goBack()" aria-label="Go back to previous step"
						class="w-16 h-16 card-glass border border-neutral-200 text-neutral-400 rounded-[2rem] flex items-center justify-center active:scale-90 transition-all shadow-sm hover:text-neutral-900 hover:bg-white">
						<i class="fa-solid fa-arrow-left text-lg" aria-hidden="true"></i>
					</button>

					<!-- Next/Create Button -->
					<button (click)="goNext()" [disabled]="!canGoNext || isSubmitting"
						[attr.aria-label]="currentStep === 'duration' ? 'Ignite Habit and create tracker' : 'Advance to next step'"
						class="flex-1 h-16 bg-neutral-950 text-white rounded-[2rem] font-black tracking-widest uppercase text-xs shadow-2xl shadow-neutral-900/40 active:scale-95 transition-all flex items-center justify-center gap-3 border border-white/10 group relative overflow-hidden">

						<!-- Loading Spinner -->
						<div *ngIf="isSubmitting"
							class="absolute inset-0 flex items-center justify-center bg-neutral-950 z-10 transition-opacity">
							<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin">
							</div>
						</div>

						<span>{{ currentStep === 'duration' ? 'Ignite Habit' : 'Advance' }}</span>
						<i *ngIf="currentStep !== 'duration'"
							class="fa-solid fa-arrow-right text-[10px] group-hover:translate-x-1 transition-transform"
							aria-hidden="true"></i>
						<i *ngIf="currentStep === 'duration'"
							class="fa-solid fa-rocket text-xs group-hover:-translate-y-1 group-hover:translate-x-1 transition-transform"
							aria-hidden="true"></i>
					</button>
				</div>
			</div>
		</ion-footer>

		</div>
	</ng-template>
</ion-modal>