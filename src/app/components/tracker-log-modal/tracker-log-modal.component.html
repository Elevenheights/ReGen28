<!-- Clean Logging Modal -->
<ion-modal [isOpen]="isOpen" (didDismiss)="closeModal()" class="clean-modal">
	<ng-template>
		<div class="h-full flex flex-col bg-neutral-50 relative" *ngIf="tracker"
			[style.--tracker-color]="tracker.color">

			<!-- 1. Header (Sacred Glass) -->
			<ion-header class="ion-no-border">
				<div
					class="px-6 pt-10 pb-6 bg-white/90 backdrop-blur-2xl sticky top-0 z-50 flex justify-between items-center border-b border-neutral-100/30 overflow-hidden">
					<!-- Ambient Glow -->
					<div class="absolute -top-10 -left-10 w-40 h-40 bg-indigo-500/5 rounded-full blur-3xl"></div>
					<div class="absolute -bottom-10 -right-10 w-40 h-40 bg-purple-500/5 rounded-full blur-3xl"></div>

					<div class="relative z-10 group cursor-pointer">
						<!-- Hidden Native Select -->
						<ion-select class="absolute inset-0 opacity-0 w-full h-full z-10" [value]="tracker.id"
							(ionChange)="onTrackerSelectChange($event)" interface="popover">
							<ion-select-option *ngFor="let t of activeTrackers" [value]="t.id">
								{{ t.name }}
							</ion-select-option>
						</ion-select>

						<div class="flex items-center gap-2">
							<h2 class="text-3xl font-black text-neutral-900 tracking-tighter">{{ tracker.name }}</h2>
							<i
								class="fa-solid fa-chevron-down text-neutral-300 text-sm group-hover:text-neutral-900 transition-colors"></i>
						</div>
						<div class="flex items-center space-x-2 mt-1.5">
							<div class="w-2.5 h-2.5 rounded-full shadow-inner" [style.background-color]="tracker.color">
							</div>
							<span class="text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em]">{{
								tracker.category }}</span>
						</div>
					</div>
					<button (click)="closeModal()"
						class="w-12 h-12 rounded-2xl bg-neutral-100/50 flex items-center justify-center text-neutral-400 active:scale-90 transition-all hover:bg-neutral-100 hover:text-neutral-900 shadow-sm relative z-10">
						<i class="fa-solid fa-times text-xl"></i>
					</button>
				</div>
			</ion-header>

			<!-- 2. Ion Content (Replaces previous div for guaranteed scrolling) -->
			<ion-content [fullscreen]="true" class="ion-padding-bottom" [style.--background]="'transparent'">
				<div class="px-5 pt-6 pb-32 space-y-6">

					<!-- PRIMARY INPUT (Hero Section) -->
					<div class="flex flex-col items-center justify-center py-4 animate-entry">

						<!-- Boolean Input -->
						<div *ngIf="tracker.type === 'boolean'" class="w-full flex justify-center py-6">
							<button (click)="loggingForm.value = loggingForm.value ? 0 : 1"
								[style.background-color]="loggingForm.value ? tracker.color : null"
								[class]="loggingForm.value ? 'scale-110 shadow-2xl shadow-indigo-500/30 text-white' : 'bg-white border-2 border-dashed border-neutral-200 text-neutral-300 scale-100'"
								class="w-40 h-40 rounded-full flex flex-col items-center justify-center transition-all duration-500 group relative overflow-hidden">
								<!-- Ripple effect simulation -->
								<div *ngIf="loggingForm.value" class="absolute inset-0 bg-white/20 animate-pulse"></div>

								<i class="fa-solid fa-check text-5xl mb-3 relative z-10 transition-transform group-active:scale-90"
									[class.animate-bounce-slow]="loggingForm.value"></i>
								<span class="text-[10px] font-black uppercase tracking-[0.2em] relative z-10">{{
									loggingForm.value ?
									'Victorious' : 'Complete' }}</span>
							</button>
						</div>

						<!-- Numeric/Range Input -->
						<div *ngIf="tracker.type !== 'boolean'" class="w-full text-center">
							<div class="mb-8 relative inline-block">
								<span class="text-7xl font-black text-neutral-900 tracking-tighter"
									[appCountUp]="loggingForm.value" [duration]="500"></span>
								<span
									class="absolute -right-8 top-2 text-[10px] font-black text-neutral-400 uppercase tracking-widest rotate-90 origin-left">{{
									tracker.unit || 'Units' }}</span>
							</div>

							<!-- Stepper Controls -->
							<div
								class="card-glass p-3 rounded-[2.5rem] flex items-center justify-between max-w-sm mx-auto shadow-2xl shadow-indigo-500/10">
								<button (click)="decrementValue()"
									class="w-14 h-14 rounded-2xl bg-neutral-100/50 flex items-center justify-center text-neutral-600 active:scale-90 transition-all hover:bg-neutral-100 hover:text-neutral-900 pulse-on-click">
									<i class="fa-solid fa-minus"></i>
								</button>

								<div class="flex-1 px-4">
									<ion-range [(ngModel)]="loggingForm.value" [min]="getValueInputConfig().min"
										[max]="getValueInputConfig().max" [step]="getValueInputConfig().step"
										class="clean-range">
									</ion-range>
								</div>

								<button (click)="incrementValue()" [style.background-color]="tracker.color"
									class="w-14 h-14 rounded-2xl text-white flex items-center justify-center shadow-lg active:scale-95 transition-all pulse-on-click">
									<i class="fa-solid fa-plus font-bold"></i>
								</button>
							</div>
						</div>
					</div>

					<!-- Date & Time (Clean Cards) -->
					<div class="grid grid-cols-2 gap-3 animate-entry delay-100">
						<div
							class="card-glass rounded-[2rem] p-5 relative overflow-hidden group hover:bg-white/95 transition-all active:scale-[0.98]">
							<span
								class="text-[9px] font-black text-neutral-400 uppercase tracking-widest block mb-2">Date</span>
							<div class="flex items-center gap-2">
								<i class="fa-solid fa-calendar-day text-indigo-400 text-xs"></i>
								<span class="text-sm font-black text-neutral-900">{{ loggingForm.customDateEnabled ?
									(loggingForm.date | date:'mediumDate') : 'Today' }}</span>
							</div>
							<input type="date" [(ngModel)]="loggingForm.date"
								class="absolute inset-0 opacity-0 cursor-pointer"
								(change)="loggingForm.customDateEnabled = true">
						</div>

						<div
							class="card-glass rounded-[2rem] p-5 relative overflow-hidden group hover:bg-white/95 transition-all active:scale-[0.98]">
							<span
								class="text-[9px] font-black text-neutral-400 uppercase tracking-widest block mb-2">Time</span>
							<div class="flex items-center gap-2">
								<i class="fa-solid fa-clock text-indigo-400 text-xs"></i>
								<span class="text-sm font-black text-neutral-900">{{ loggingForm.customTimeEnabled ?
									loggingForm.time : getCurrentTimeString() }}</span>
							</div>
							<input type="time" [(ngModel)]="loggingForm.time"
								class="absolute inset-0 opacity-0 cursor-pointer"
								(change)="loggingForm.customTimeEnabled = true">
						</div>
					</div>

					<!-- Notes Area -->
					<div class="card-glass rounded-[2.5rem] p-6 animate-entry delay-100 shadow-xl shadow-neutral-500/5">
						<textarea [(ngModel)]="loggingForm.notes" placeholder="How did it feel?"
							class="w-full bg-transparent text-neutral-800 placeholder-neutral-300 text-base font-medium resize-none outline-none min-h-[100px]"
							rows="3"></textarea>
					</div>

					<!-- Details Accordion -->
					<div class="space-y-4 animate-entry delay-200">
						<div class="flex items-center gap-3">
							<div class="h-px bg-neutral-200 flex-1"></div>
							<span class="text-xs font-bold text-neutral-400 uppercase tracking-widest">Details</span>
							<div class="h-px bg-neutral-200 flex-1"></div>
						</div>

						<!-- Mood & Energy -->
						<div class="grid grid-cols-2 gap-3"
							*ngIf="shouldShowField('mood') || shouldShowField('energy')">
							<div *ngIf="shouldShowField('mood')" class="card-glass rounded-[2rem] p-5">
								<div class="flex justify-between items-center mb-4">
									<span
										class="text-[10px] font-black text-neutral-400 uppercase tracking-widest">Mood</span>
									<span class="text-xl animate-bounce duration-500">{{ getMoodEmoji(loggingForm.mood)
										}}</span>
								</div>
								<ion-range [(ngModel)]="loggingForm.mood" min="1" max="10" step="1"
									class="clean-range-sm range-mood"></ion-range>
							</div>

							<div *ngIf="shouldShowField('energy')" class="card-glass rounded-[2rem] p-5">
								<div class="flex justify-between items-center mb-4">
									<span
										class="text-[10px] font-black text-neutral-400 uppercase tracking-widest">Energy</span>
									<span class="text-xs font-black text-amber-500 uppercase tracking-tighter">{{
										loggingForm.energy }}/5</span>
								</div>
								<ion-range [(ngModel)]="loggingForm.energy" min="1" max="5" step="1"
									class="clean-range-sm" color="warning"></ion-range>
							</div>
						</div>

						<!-- Tags -->
						<div *ngIf="shouldShowField('tags')" class="card-glass rounded-[2.5rem] p-6">
							<span
								class="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-4">Patterns
								& Tags</span>
							<div class="flex flex-wrap gap-2 mb-4">
								<span *ngFor="let tag of loggingForm.tags; let i = index" (click)="removeTag(i)"
									class="bg-indigo-50 text-indigo-600 border border-indigo-100 text-[10px] px-3 py-1.5 rounded-xl font-black uppercase tracking-wider flex items-center cursor-pointer hover:bg-red-50 hover:text-red-500 hover:border-red-100 transition-all">
									#{{ tag }}
								</span>
							</div>
							<div
								class="flex items-center gap-3 bg-neutral-100/50 rounded-2xl px-4 py-3 border border-neutral-100/50 focus-within:bg-white focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
								<i class="fa-solid fa-hashtag text-neutral-400 text-xs"></i>
								<input #tagInput (keyup.enter)="addTag(tagInput.value); tagInput.value = ''"
									placeholder="Add tag..."
									class="bg-transparent text-sm w-full outline-none text-neutral-700 font-bold">
								<button (click)="addTag(tagInput.value); tagInput.value = ''"
									class="text-indigo-400 hover:text-indigo-600 transition-colors"><i
										class="fa-solid fa-plus-circle text-lg"></i></button>
							</div>
						</div>

						<!-- Quality & Intensity -->
						<div class="grid grid-cols-2 gap-3"
							*ngIf="shouldShowField('intensity') || shouldShowField('quality')">
							<div *ngIf="shouldShowField('intensity')" class="glass-panel rounded-2xl p-4">
								<div class="flex justify-between items-center mb-2">
									<span class="text-xs font-bold text-neutral-500">Intensity</span>
									<span class="text-xs font-bold text-red-500">{{ loggingForm.intensity }}/10</span>
								</div>
								<ion-range [(ngModel)]="loggingForm.intensity" min="1" max="10" step="1"
									class="clean-range-sm" color="danger"></ion-range>
							</div>
							<div *ngIf="shouldShowField('quality')" class="glass-panel rounded-2xl p-4">
								<div class="flex justify-between items-center mb-2">
									<span class="text-xs font-bold text-neutral-500">Quality</span>
									<span class="text-xs font-bold text-emerald-500">{{ loggingForm.quality }}/10</span>
								</div>
								<ion-range [(ngModel)]="loggingForm.quality" min="1" max="10" step="1"
									class="clean-range-sm" color="success"></ion-range>
							</div>
						</div>

						<!-- Social Context -->
						<div *ngIf="shouldShowField('socialContext')" class="card-glass rounded-[2.5rem] p-6">
							<span
								class="text-[10px] font-black text-neutral-400 uppercase tracking-widest block mb-4">Who
								are you with?</span>
							<div class="grid grid-cols-3 gap-2">
								<button *ngFor="let option of getSocialContextOptions()"
									(click)="loggingForm.socialContext = option.value"
									[class]="getSocialContextButtonClass(option.value)"
									class="py-4 rounded-2xl transition-all duration-300 pulse-on-click flex flex-col items-center justify-center gap-2">
									<i [class]="option.icon" class="text-2xl mb-1"></i>
									<span class="text-[9px] font-black uppercase tracking-widest leading-none">{{
										option.label }}</span>
								</button>
							</div>
						</div>

						<!-- Photo Upload -->
						<div *ngIf="shouldShowField('photos')" class="card-glass rounded-[2.5rem] p-6">
							<div class="flex justify-between items-center mb-4">
								<span class="text-[10px] font-black text-neutral-400 uppercase tracking-widest">Visual
									Evidence</span>
								<span
									class="text-[9px] font-black bg-neutral-100 text-neutral-500 px-2 py-0.5 rounded-full uppercase tracking-widest">{{
									loggingForm.photos?.length || 0 }}/3</span>
							</div>

							<div class="grid grid-cols-4 gap-3">
								<div *ngFor="let photo of loggingForm.photos; let i = index"
									class="aspect-square rounded-2xl bg-neutral-100 relative group overflow-hidden shadow-sm border border-neutral-100">
									<img [src]="photo" class="w-full h-full object-cover">
									<button (click)="removePhoto(i)"
										class="absolute top-1.5 right-1.5 w-6 h-6 bg-black/60 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">
										<i class="fa-solid fa-times text-[10px]"></i>
									</button>
								</div>

								<button (click)="addPhoto()"
									class="aspect-square rounded-2xl bg-neutral-50 border-2 border-dashed border-neutral-200 flex flex-col items-center justify-center text-neutral-400 hover:bg-white hover:border-indigo-300 hover:text-indigo-500 transition-all active:scale-95 group">
									<i
										class="fa-solid fa-camera text-xl mb-1.5 group-hover:scale-110 transition-transform"></i>
									<span class="text-[9px] font-black uppercase tracking-widest">Add</span>
								</button>
							</div>
						</div>

					</div>
				</div>
			</ion-content>

			<!-- 3. Floating Action Bar -->
			<ion-footer class="ion-no-border bg-transparent shadow-none">
				<div class="px-6 pb-10 pt-4 bg-gradient-to-t from-neutral-50 via-neutral-50 to-transparent">
					<button (click)="logTrackerEntry()" [disabled]="isSubmittingEntry"
						class="w-full h-16 bg-neutral-950 text-white rounded-[2rem] font-black tracking-widest uppercase text-xs shadow-2xl shadow-neutral-900/40 active:scale-95 transition-all flex items-center justify-center gap-3 border border-white/10 btn-save-entry group">
						<div *ngIf="isSubmittingEntry"
							class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
						<span *ngIf="!isSubmittingEntry">Commit to Flow</span>
						<i *ngIf="!isSubmittingEntry"
							class="fa-solid fa-arrow-right text-[10px] group-hover:translate-x-1 transition-transform"></i>
					</button>
				</div>
			</ion-footer>

		</div>
	</ng-template>
</ion-modal>